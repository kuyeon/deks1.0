# Deks 1.0 아키텍처 설계

## 🏗️ 전체 시스템 구조

```
┌─────────────────┐    Wi-Fi TCP    ┌─────────────────────────────────────────┐    HTTP/WebSocket   ┌─────────────────┐
|                 |                 │            FastAPI Server               │                     |                 |
│                 │◄───────────────►│  ┌─────────────────────────────────────┐ │◄───────────────────►│  Web Browser    │
│   ESP32 S3      │                 │  │         REST API Layer             │ │                     │                 │
│ (마이크로파이썬)  │                 │  │  • Robot Control APIs              │ │                     │  (프론트엔드)    │
│                 │                 │  │  • Natural Language Processing     │ │                     │                 │
└─────────────────┘                 │  │  • User Experience APIs            │ │                     │                 │
         │                          │  └─────────────────────────────────────┘ │                     │                 │
         ▼                          │  ┌─────────────────────────────────────┐ │                     │                 │
┌─────────────────┐                 │  │        WebSocket Layer              │ │                     │                 │
│   하드웨어 센서   │                 │  │  • Real-time Communication         │ │                     │                 │
│   • FIT0405 모터 │                 │  │  • Live Sensor Data                 │ │                     │                 │
│   • 엔코더       │                 │  └─────────────────────────────────────┘ │                     │                 │
│   • 적외선 센서  │                 │  ┌─────────────────────────────────────┐ │                     │                 │
│   • 1588AS LED  │                 │  │       Socket Bridge Module          │ │                     │                 │
│   • 패시브 버저  │                 │  │  • TCP Socket Management           │ │                     │                 │
└─────────────────┘                 │  │  • ESP32 Communication             │ │                     │                 │
                                    │  │  • Message Protocol Handling       │ │                     │                 │
                                    │  └─────────────────────────────────────┘ │                     │                 │
                                    │  ┌─────────────────────────────────────┐ │                     │                 │
                                    │  │         Database Layer              │ │                     │                 │
                                    │  │  • SQLite Database                 │ │                     │                 │
                                    │  │  • User Analytics                  │ │                     │                 │
                                    │  └─────────────────────────────────────┘ │                     │                 │
                                    └─────────────────────────────────────────┘                     └─────────────────┘
```

## 🧩 컴포넌트별 상세 구조

### 1. ESP32 S3 (로봇 두뇌)
```
┌─────────────────────────────────────────┐
│              ESP32 S3                   │
├─────────────────────────────────────────┤
│  • 마이크로파이썬 펌웨어                   │
│  • Wi-Fi 클라이언트                       │
│  • TCP Socket 클라이언트                  │
├─────────────────────────────────────────┤
│              제어 모듈                   │
│  • 모터 제어 (L298N)                     │
│  • 엔코더 읽기                           │
│  • 센서 데이터 수집                       │
│  • 안전 시스템                           │
├─────────────────────────────────────────┤
│              통신 모듈                   │
│  • 명령 수신 및 처리                      │
│  • 센서 데이터 전송                       │
│  • 상태 보고                             │
└─────────────────────────────────────────┘
```

### 2. FastAPI 서버 (통합)
```
┌─────────────────────────────────────────┐
│            FastAPI Server               │
├─────────────────────────────────────────┤
│  • REST API 엔드포인트                    │
│  • WebSocket 연결 관리                    │
│  • 명령 처리 및 라우팅                     │
│  • 센서 데이터 저장/분석                   │
├─────────────────────────────────────────┤
│              핵심 모듈                    │
│  • 로봇 제어 API                          │
│  • 센서 데이터 API                        │
│  • 대화 처리 API                          │
│  • 채팅 상호작용 API                      │
│  • 매핑 데이터 API                        │
│  • 자연어 처리 모듈                       │
│  • SQLite 데이터베이스                     │
│  • Socket Bridge 모듈 (ESP32 통신)        │
├─────────────────────────────────────────┤
│            Socket Bridge 모듈            │
│  • TCP Socket 관리 (포트 8888)            │
│  • ESP32 연결 상태 모니터링                │
│  • 메시지 프로토콜 처리                    │
│  • 실시간 데이터 스트리밍                  │
│  • 명령 전송 및 응답 처리                  │
│  • 연결 품질 관리                         │
└─────────────────────────────────────────┘
```

### 3. 웹 프론트엔드
```
┌─────────────────────────────────────────┐
│           Web Frontend                  │
├─────────────────────────────────────────┤
│  • HTML5 + CSS3 + JavaScript            │
│  • WebSocket 클라이언트                   │
│  • 실시간 UI 업데이트                     │
│  • 사용자 인터랙션 처리                    │
├─────────────────────────────────────────┤
│              UI 컴포넌트                  │
│  • 채팅 인터페이스                        │
│  • 자연어 명령 입력                       │
│  • 로봇 상태 모니터                       │
│  • 수동 제어 패널                         │
│  • 센서 데이터 시각화                      │
│  • 매핑 뷰어                             │
└─────────────────────────────────────────┘
```

## 🔄 데이터 흐름

### 1. 자연어 명령 흐름
```
사용자 자연어 입력 → 웹 프론트엔드 → FastAPI (자연어 처리) → 명령 변환 → Socket Bridge 모듈 → TCP Socket → ESP32 → 하드웨어 제어
```

### 2. 센서 데이터 흐름
```
하드웨어 센서 → ESP32 → TCP Socket → Socket Bridge 모듈 → FastAPI → WebSocket → 웹 프론트엔드 → UI 표시
```

### 3. 안전 시스템 흐름
```
센서 감지 → ESP32 (즉시 처리) → TCP Socket → Socket Bridge 모듈 → FastAPI (상태 보고) → 웹 (알림 표시)
```

### 4. 대화 처리 흐름
```
사용자 메시지 → 웹 채팅 → FastAPI (자연어 파싱) → 로봇 응답 생성 → 웹 채팅 표시
```

## 🛡️ 안전 시스템 아키텍처

### 다층 안전 구조
```
1. 하드웨어 레벨 (ESP32)
   ├── 즉시 정지 (낙하 감지)
   ├── 모터 브레이크
   └── 비상 모드 진입

2. 소프트웨어 레벨 (FastAPI)
   ├── 센서 데이터 검증
   ├── 명령 안전성 검사
   └── 로봇 상태 모니터링

3. 사용자 레벨 (웹 인터페이스)
   ├── 수동 비상 정지 버튼
   ├── 위험 상태 알림
   └── 로봇 상태 실시간 표시
```

## 🤖 자연어 처리 아키텍처

### 규칙 기반 명령 파싱 시스템
```
┌─────────────────────────────────────────┐
│         자연어 입력 처리                  │
├─────────────────────────────────────────┤
│  • 텍스트 전처리 (소문자 변환, 공백 제거)  │
│  • 키워드 매칭                          │
│  • 의도 분류                           │
│  • 명령 검증                           │
├─────────────────────────────────────────┤
│         지원 명령어 패턴                  │
│  • move_forward: ["앞으로", "전진", ...] │
│  • turn_left: ["왼쪽", "좌회전", ...]    │
│  • turn_right: ["오른쪽", "우회전", ...] │
│  • stop: ["정지", "멈춰", ...]          │
│  • spin: ["빙글빙글", "돌아", ...]      │
└─────────────────────────────────────────┘
```

### 명령 처리 파이프라인
```
1. 자연어 입력 수신
   ↓
2. 텍스트 정규화 (소문자, 공백 처리)
   ↓
3. 패턴 매칭 (키워드 검색)
   ↓
4. 의도 분류 (가장 높은 신뢰도 선택)
   ↓
5. 명령 변환 (JSON 형식)
   ↓
6. 로봇 제어 명령 전송
```

### 응답 생성 시스템
```
┌─────────────────────────────────────────┐
│           응답 생성 모듈                  │
├─────────────────────────────────────────┤
│  • 성공 응답: "앞으로 이동합니다!"        │
│  • 실패 응답: "이해하지 못했습니다"        │
│  • 안전 알림: "낙하 감지! 정지합니다!"     │
│  • 상태 보고: "현재 위치: (10, 20)"       │
└─────────────────────────────────────────┘
```

## 🗄️ 데이터베이스 아키텍처

### SQLite 기반 사용자 경험 향상 시스템
```
┌─────────────────────────────────────────┐
│            SQLite Database              │
├─────────────────────────────────────────┤
│  • user_interactions                    │
│  • command_frequency                    │
│  • error_patterns                       │
│  • emotion_responses                    │
├─────────────────────────────────────────┤
│           데이터 처리 모듈                │
│  • 사용자 패턴 분석                      │
│  • 명령어 학습 시스템                     │
│  • 스마트 제안 엔진                      │
│  • 에러 패턴 분석                        │
└─────────────────────────────────────────┘
```

### 데이터 흐름 (사용자 경험 향상)
```
사용자 명령 → 자연어 처리 → SQLite 저장 → 패턴 분석 → 개인화된 제안
     ↓              ↓           ↓           ↓
명령 실행 → 결과 저장 → 빈도 업데이트 → 학습 데이터 → 향후 개선
```

### 데이터베이스 모듈 구조
```
┌─────────────────────────────────────────┐
│         Database Manager                │
├─────────────────────────────────────────┤
│  • Connection Pool                      │
│  • Query Builder                        │
│  • Data Validation                      │
├─────────────────────────────────────────┤
│         Analytics Engine                │
│  • Pattern Recognition                  │
│  • Frequency Analysis                   │
│  • Error Pattern Detection              │
│  • User Preference Learning             │
├─────────────────────────────────────────┤
│         Recommendation System           │
│  • Smart Suggestions                    │
│  • Personalized Commands                │
│  • Context-Aware Responses              │
└─────────────────────────────────────────┘
```

## 💬 채팅 상호작용 모듈 구조

### 채팅 시스템 아키텍처
```
┌─────────────────────────────────────────┐
│         Chat Interaction Module         │
├─────────────────────────────────────────┤
│  • Message Processing                   │
│  • Context Management                   │
│  • Emotion State Tracking               │
│  • Conversation History                 │
├─────────────────────────────────────────┤
│         Natural Language Processing     │
│  • Intent Recognition                   │
│  • Emotion Analysis                     │
│  • Context Understanding                │
│  • Response Generation                  │
├─────────────────────────────────────────┤
│         Conversation Manager            │
│  • Session Management                   │
│  • User Profile Tracking                │
│  • Conversation Flow Control            │
│  • Learning from Interactions           │
├─────────────────────────────────────────┤
│         Response Engine                 │
│  • Template-based Responses             │
│  • Dynamic Response Generation          │
│  • Personality Adaptation               │
│  • Multi-turn Conversation Support      │
└─────────────────────────────────────────┘
```

### 채팅 데이터베이스 스키마
```
┌─────────────────────────────────────────┐
│            Chat Database                │
├─────────────────────────────────────────┤
│  • chat_conversations                   │
│    - conversation_id                    │
│    - user_id                           │
│    - session_id                        │
│    - start_time                        │
│    - end_time                          │
│    - conversation_type                 │
├─────────────────────────────────────────┤
│  • chat_messages                       │
│    - message_id                        │
│    - conversation_id                   │
│    - user_message                      │
│    - robot_response                    │
│    - emotion_detected                  │
│    - emotion_responded                 │
│    - timestamp                         │
├─────────────────────────────────────────┤
│  • user_profiles                       │
│    - user_id                           │
│    - user_name                         │
│    - preferred_style                   │
│    - conversation_history_count        │
│    - last_interaction                  │
├─────────────────────────────────────────┤
│  • chat_contexts                       │
│    - context_id                        │
│    - user_id                           │
│    - session_id                        │
│    - current_topic                     │
│    - robot_mood                        │
│    - remembered_info                   │
└─────────────────────────────────────────┘
```

### 채팅 데이터 흐름
```
사용자 메시지 → 의도 분석 → 감정 분석 → 컨텍스트 조회 → 응답 생성 → 데이터베이스 저장
     ↓              ↓           ↓           ↓            ↓           ↓
로그 저장 → 패턴 학습 → 개인화 → 대화 기록 → 감정 상태 업데이트 → 다음 대화 준비
```

### 채팅 시나리오 처리 흐름
```
┌─────────────────────────────────────────┐
│         Scenario Handler                │
├─────────────────────────────────────────┤
│  1. 메시지 분류                         │
│     • 인사말 (greeting)                 │
│     • 자기소개 (introduction)           │
│     • 질문 (question)                   │
│     • 명령 (command)                    │
│     • 작별인사 (farewell)               │
├─────────────────────────────────────────┤
│  2. 컨텍스트 기반 응답                  │
│     • 사용자 이름 기억                  │
│     • 이전 대화 내용 참조               │
│     • 감정 상태 반영                    │
│     • 개인화된 스타일 적용              │
├─────────────────────────────────────────┤
│  3. 학습 및 개선                        │
│     • 사용자 피드백 수집                │
│     • 대화 패턴 분석                    │
│     • 응답 품질 개선                    │
│     • 개인화 레벨 향상                  │
└─────────────────────────────────────────┘
```

## 📊 성능 요구사항

### 실시간성
- **센서 데이터 수집**: 50Hz (20ms 간격)
- **명령 응답 시간**: < 100ms
- **안전 시스템 응답**: < 10ms
- **자연어 처리**: < 50ms

### 네트워크
- **Wi-Fi 연결**: 2.4GHz
- **데이터 전송량**: ~1KB/s
- **연결 안정성**: 자동 재연결 지원

## 🔄 확장성 고려사항

### 미래 확장 계획
1. **멀티 로봇 지원**: 여러 Deks 로봇 동시 제어
2. **클라우드 연동**: 원격 모니터링 및 제어
3. **AI 통합**: 음성 인식, 자연어 처리
4. **IoT 연동**: 스마트 홈 시스템 연결

### 모듈화 설계
- 각 컴포넌트는 독립적으로 교체 가능
- API 기반 통신으로 느슨한 결합
- 마이크로서비스 아키텍처 적용 가능

---

**Deks 1.0 아키텍처** - 확장 가능하고 안전한 로봇 플랫폼
