# Deks 1.0 아키텍처 설계

## 🏗️ 전체 시스템 구조

```
┌─────────────────┐    Wi-Fi     ┌─────────────────┐    Websocket     ┌─────────────────┐    HTTP/WebSocket    ┌─────────────────┐              │Socket/WebSocket│
│                 │◄────────────►◄────────────►│                 │◄───────────────────►│                 │
│   ESP32 S3      │              │  FastAPI Server │                     │  Web Browser    │
│ (마이크로파이썬) │                │   (파이썬)       │                     │  (프론트엔드)    │
│                 │               │   브리지 서버    ││                 │                     │                 │
└─────────────────┘               │   (파이썬)       │└─────────────────┘                     └─────────────────┘
         │                        └─────────────────┘
         ▼                  
┌─────────────────┐              
│   하드웨어 센서     │             
│   • FIT0405 모터  │              
│   • 엔코더        │              
│   • 적외선 센서    │           
│   • 1588AS LED   │            
│   • 패시브 버저    │
└─────────────────┘
```

## 🧩 컴포넌트별 상세 구조

### 1. ESP32 S3 (로봇 두뇌)
```
┌─────────────────────────────────────────┐
│              ESP32 S3                   │
├─────────────────────────────────────────┤
│  • 마이크로파이썬 펌웨어                    │
│  • Wi-Fi 클라이언트                     │
│  • HTTP/Socket 서버             │
├─────────────────────────────────────────┤
│              제어 모듈                    │
│  • 모터 제어 (L298N)                   │
│  • 엔코더 읽기                          │
│  • 센서 데이터 수집                      │
│  • 안전 시스템                          │
├─────────────────────────────────────────┤
│              통신 모듈                    │
│  • 명령 수신 및 처리                     │
│  • 센서 데이터 전송                      │
│  • 상태 보고                           │
└─────────────────────────────────────────┘
```

### 2. FastAPI 서버 (백엔드)
```
┌─────────────────────────────────────────┐
│            FastAPI Server               │
├─────────────────────────────────────────┤
│  • REST API 엔드포인트                   │
│  • WebSocket 연결 관리                   │
│  • 명령 처리 및 라우팅                   │
│  • 센서 데이터 저장/분석                 │
├─────────────────────────────────────────┤
│              핵심 모듈                    │
│  • 로봇 제어 API                        │
│  • 센서 데이터 API                      │
│  • 대화 처리 API                        │
│  • 매핑 데이터 API                      │
└─────────────────────────────────────────┘
```

### 3. WebSocket 브리지 서버
```
┌─────────────────────────────────────────┐
│         WebSocket Bridge Server         │
├─────────────────────────────────────────┤
│  • ESP32 ↔ 웹 브라우저 중계              │
│  • 실시간 데이터 스트리밍                │
│  • 연결 상태 관리                       │
│  • 메시지 라우팅                        │
├─────────────────────────────────────────┤
│              기능 모듈                    │
│  • 센서 데이터 스트림                    │
│  • 로봇 상태 브로드캐스트                │
│  • 사용자 명령 전달                      │
│  • 에러 알림                            │
└─────────────────────────────────────────┘
```

### 4. 웹 프론트엔드
```
┌─────────────────────────────────────────┐
│           Web Frontend                  │
├─────────────────────────────────────────┤
│  • HTML5 + CSS3 + JavaScript           │
│  • WebSocket 클라이언트                 │
│  • 실시간 UI 업데이트                   │
│  • 사용자 인터랙션 처리                  │
├─────────────────────────────────────────┤
│              UI 컴포넌트                  │
│  • 채팅 인터페이스                      │
│  • 로봇 상태 모니터                     │
│  • 수동 제어 패널                       │
│  • 센서 데이터 시각화                    │
│  • 매핑 뷰어                           │
└─────────────────────────────────────────┘
```

## 🔄 데이터 흐름

### 1. 사용자 명령 흐름
```
사용자 입력 → 웹 프론트엔드 → WebSocket → FastAPI → ESP32 → 하드웨어 제어
```

### 2. 센서 데이터 흐름
```
하드웨어 센서 → ESP32 → FastAPI → WebSocket → 웹 프론트엔드 → UI 표시
```

### 3. 안전 시스템 흐름
```
센서 감지 → ESP32 (즉시 처리) → FastAPI (상태 보고) → 웹 (알림 표시)
```

## 📡 통신 프로토콜

### HTTP REST API
- **Base URL**: `http://server-ip:8000/api/v1`
- **인증**: API 키 기반 (선택사항)
- **데이터 형식**: JSON

### WebSocket 연결
- **URL**: `ws://server-ip:8000/ws`
- **프로토콜**: 표준 WebSocket
- **메시지 형식**: JSON

## 🔧 하드웨어 인터페이스

### ESP32 S3 핀 구성
```
GPIO 2, 3    → L298N 모터 드라이버 (PWM)
GPIO 4, 5    → 엔코더 A, B 채널
GPIO 6       → 적외선 센서 (낙하 방지)
GPIO 7       → 적외선 센서 (장애물 감지)
GPIO 8       → 1588AS LED 매트릭스 (I2C)
GPIO 9       → 패시브 버저 (PWM)
GPIO 1, 0    → 시리얼 디버그
```

### 센서 데이터 형식
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "robot_id": "deks_001",
  "sensors": {
    "encoder_left": 1234,
    "encoder_right": 1235,
    "ir_drop_sensor": 850,
    "ir_obstacle_sensor": 200,
    "battery_level": 85
  },
  "status": "moving",
  "position": {
    "x": 10.5,
    "y": 20.3,
    "theta": 1.57
  }
}
```

## 🛡️ 안전 시스템 아키텍처

### 다층 안전 구조
```
1. 하드웨어 레벨 (ESP32)
   ├── 즉시 정지 (낙하 감지)
   ├── 모터 브레이크
   └── 비상 모드 진입

2. 소프트웨어 레벨 (FastAPI)
   ├── 센서 데이터 검증
   ├── 명령 안전성 검사
   └── 로봇 상태 모니터링

3. 사용자 레벨 (웹 인터페이스)
   ├── 수동 비상 정지 버튼
   ├── 위험 상태 알림
   └── 로봇 상태 실시간 표시
```

## 📊 성능 요구사항

### 실시간성
- **센서 데이터 수집**: 50Hz (20ms 간격)
- **명령 응답 시간**: < 100ms
- **안전 시스템 응답**: < 10ms

### 네트워크
- **Wi-Fi 연결**: 2.4GHz
- **데이터 전송량**: ~1KB/s
- **연결 안정성**: 자동 재연결 지원

## 🔄 확장성 고려사항

### 미래 확장 계획
1. **멀티 로봇 지원**: 여러 Deks 로봇 동시 제어
2. **클라우드 연동**: 원격 모니터링 및 제어
3. **AI 통합**: 음성 인식, 자연어 처리
4. **IoT 연동**: 스마트 홈 시스템 연결

### 모듈화 설계
- 각 컴포넌트는 독립적으로 교체 가능
- API 기반 통신으로 느슨한 결합
- 마이크로서비스 아키텍처 적용 가능

---

**Deks 1.0 아키텍처** - 확장 가능하고 안전한 로봇 플랫폼
