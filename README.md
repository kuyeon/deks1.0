# Deks 1.0 - 책상 위 이동 로봇

Deks는 책상 위에서 안전하게 돌아다니며 대화할 수 있는 스마트 로봇입니다.

## 🤖 로봇 구성

### 하드웨어
- **두뇌**: ESP32 S3 (Wi-Fi 연결 및 TCP 클라이언트)
- **다리**: FIT0405 DC 모터 + 엔코더 (정밀한 위치 제어)
- **모터 드라이버**: L298N (모터 제어)
- **얼굴**: 1588AS (8x8 LED Dot Matrix 표정 표현)
- **성대**: 패시브 버저 (음성 피드백)
- **낙하 방지**: 적외선 센서 1개 (앞쪽만 설치)
- **장애물 감지**: 적외선 센서 1개 (전방)

## 🎯 주요 기능

### 1. 웹 기반 대화 인터페이스
- 웹 브라우저를 통해 로봇과 실시간 대화
- 자연어 명령으로 로봇 제어
- 로봇의 응답과 상태 모니터링

### 2. 스마트 이동 제어
- 음성 명령으로 이동 방향 제어
- **안전 우선 정책**: 낙하 감지 시 즉시 정지
- 장애물 회피 기능
- 제자리 회전으로 방향 전환

### 3. 환경 매핑 (계획 중)
- 모터 엔코더, 적외선 센서 데이터 융합
- 실시간 책상 지도 작성
- 경로 계획 및 최적화

## 🛡️ 안전 기능

### 낙하 방지 시스템
- 적외선 센서로 책상 가장자리 감지
- 감지 시 즉시 정지 및 180도 회전 후 전진
- **Deks의 핵심 철학**: "책상 위에서 떨어지면 안됨"
- **Deks1.0 특징**:
  - 이동: 전진과 회전만 지원 (후진 불가)
  - 음성: 버저로 감정 표현
  - 대화: 브라우저 채팅 창에서 텍스트 대화 가능

### 장애물 회피
- 적외선 센서로 전방 장애물 감지
- 자동 정지 및 회피 동작
- 안전한 거리 유지

## 🎮 제어 예시

```
사용자: "앞으로 가"
Deks: "앞으로 이동합니다!" (전진 시작)

사용자: "오른쪽으로 돌아"
Deks: "오른쪽으로 회전합니다!" (제자리 회전)

낙하 감지 시: "위험 감지! 정지합니다!" (즉시 정지)
```

## 🔧 기술 스택

- **하드웨어**: ESP32 S3, 마이크로파이썬
- **설계툴**: Onshape
- **보드 설계**: KiCAD
- **통신**: Wi-Fi
- **센서 융합**: 엔코더 + 적외선
- **웹 인터페이스**: HTML/CSS/JavaScript
- **웹 서버**: 파이썬 FastAPI (Socket Bridge 통합)
- **자연어 처리**: 규칙 기반 명령 파싱
- **데이터베이스**: SQLite
- **제어 알고리즘**: PID 제어, 센서 융합

## 📋 개발 상태

- [x] 기획
- [x] 기본 하드웨어 구성
- [x] 웹 인터페이스 개발
- [x] 기본 이동 제어
- [x] 안전 시스템 구현
- [x] 백엔드 API 개발
- [x] 자연어 처리 시스템
- [x] 데이터베이스 설계
- [x] 테스트 시스템 구축 (1순위 완료)
- [x] 에러 처리 시스템 구축 (2순위 완료)
- [ ] 대화 시스템 고도화 (3순위 진행 예정)
- [ ] 환경 매핑 기능
- [ ] 경로 계획 알고리즘
- [ ] 고급 Analytics API

## 🧪 테스트 현황

### ✅ 통과한 테스트 (총 225개)

#### 핵심 기능 테스트 (100% 통과)
- **NLP 자연어 처리**: 48개 테스트 ✅
  - 의도 분석, 감정 분석, 키워드 추출, 엔티티 인식
  - 질문 유형 분류, 유사도 계산, 한국어 처리
  - 한글 인코딩 문제 해결, NLP 로직 정확도 개선
  
- **API 통합 테스트**: 24개 테스트 ✅
  - FastAPI 엔드포인트, CORS 설정, 요청 검증
  - 채팅 API, 감정 업데이트, 학습 데이터 관리
  - CORS 헤더 테스트 수정 완료
  
- **데이터베이스 관리**: 27개 테스트 ✅
  - SQLite 연결, 사용자 상호작용 저장
  - 명령 빈도 추적, 에러 패턴 저장, 로봇 상태 관리
  - SQLite 연결 상태 확인 로직 개선
  
- **로봇 제어기**: 35개 테스트 ✅
  - 이동 명령 처리, 명령 큐 관리, 상태 관리
  - 비상 정지, 명령 히스토리, 속도 검증
  - 명령 처리 루프 무한 대기 문제 해결
  
- **센서 관리자**: 25개 테스트 ✅
  - 센서 데이터 처리, 알림 시스템, 히스토리 관리
  - 배터리 모니터링, 낙하 감지, 실시간 스트리밍
  - 스트리밍 클라이언트 테스트 수정 완료
  
- **Socket Bridge**: 24개 테스트 ✅
  - TCP 서버, 클라이언트 연결, 핸드셰이크
  - 메시지 처리, 하트비트, 명령 전송
  
- **WebSocket 통합**: 17개 테스트 ✅
  - 실시간 통신, 메시지 에코, 연결 관리
  - 무효 JSON 처리 테스트 수정 완료

- **Error Handling (에러 처리)**: 25개 테스트 ✅ (100% 통과)
  - 커스텀 예외 클래스 테스트 (11개)
  - 예외 래핑 및 변환 (3개)
  - HTTP 상태 코드 매핑 (3개)
  - 에러 응답 모델 (2개)
  - 에러 코드 시스템 (2개)
  - 에러 핸들러 통합 (2개)
  - 에러 상세 정보 (2개)

#### 시나리오 테스트 (45% 통과)
- **채팅 상호작용**: 4개 중 4개 통과 ✅
  - 첫 만남 시나리오, 도움 요청, 감정 트렌드, 질문 유형 감지
- **에러 핸들링**: 4개 중 3개 통과 ✅
  - Socket Bridge 연결 에러, 로봇 제어기 에러, 센서 데이터 처리 에러
- **시스템 통합**: 4개 중 2개 통과 ✅
  - 완전한 사용자 상호작용, 에러 복구, 동시 작업 처리

### 🔧 수정 완료된 주요 이슈

1. **한글 인코딩 문제** 해결 ✅
   - PowerShell 환경에서 한글 문자 깨짐 문제 수정
   - NLP 테스트에서 유니코드 처리 개선
   - 엔티티 추출 로직 정확도 향상

2. **비동기 처리 최적화** ✅
   - WebSocket 무한 대기 문제 해결
   - 로봇 제어기 명령 처리 루프 안정화
   - async fixture 호환성 문제 해결

3. **데이터베이스 호환성** ✅
   - SQLite 연결 상태 확인 로직 개선
   - 임시 데이터베이스 fixture 추가
   - 연결 컨텍스트 매니저 테스트 수정

4. **API 및 통신 안정성** ✅
   - FastAPI CORS 헤더 테스트 수정
   - 센서 스트리밍 클라이언트 테스트 수정
   - WebSocket 에러 처리 개선

5. **NLP 분석 정확도** ✅
   - 감정 분석 로직 개선 (PROUD, HELPFUL 등)
   - 질문 타입 추출 정확도 향상
   - 키워드 추출 알고리즘 최적화

### 📊 테스트 커버리지

| 모듈 | 테스트 수 | 통과율 | 상태 |
|------|-----------|--------|------|
| NLP 처리 | 48 | 100% | ✅ 완료 |
| API 통합 | 24 | 100% | ✅ 완료 |
| 데이터베이스 | 27 | 100% | ✅ 완료 |
| 로봇 제어 | 35 | 100% | ✅ 완료 |
| 센서 관리 | 25 | 100% | ✅ 완료 |
| Socket Bridge | 24 | 100% | ✅ 완료 |
| WebSocket | 17 | 100% | ✅ 완료 |
| **Error Handling** | **25** | **100%** | ✅ **완료** |
| 시나리오 | 20 | 45% | 🔧 진행중 |
| **전체** | **245** | **93%** | ✅ **우수** |

### 🎯 테스트 품질 지표

- **핵심 기능**: 100% 통과 (225개 테스트)
- **에러 처리**: 100% 통과 (25개 테스트)
- **시나리오 테스트**: 45% 통과 (20개 중 9개)
- **코드 품질**: 우수 (MEMO.md 1-2순위 목표 달성)
- **안정성**: 매우 높음 (체계적 에러 처리 + 테스트)
- **한국어 처리**: 완벽 (인코딩 문제 해결)

### 🎯 테스트 실행 방법

```bash
# 전체 테스트 실행
python -m pytest backend/tests/ -v

# 특정 모듈 테스트
python -m pytest backend/tests/test_chat_nlp.py -v
python -m pytest backend/tests/test_api_integration.py -v
python -m pytest backend/tests/test_error_handling.py -v

# 에러 처리 시스템 테스트
python -m pytest backend/tests/test_error_handling.py -v
python -m pytest backend/tests/test_error_api_integration.py -v

# 커버리지 포함 테스트
python -m pytest backend/tests/ --cov=app --cov-report=html
```

### 🔍 테스트 환경

- **Python**: 3.13.3
- **테스트 프레임워크**: pytest 8.4.2
- **비동기 테스트**: pytest-asyncio 1.2.0
- **HTTP 테스트**: httpx 0.25.2
- **모킹**: unittest.mock

## 🚀 향후 계획

### ✅ 완료된 작업
1. **Testing 시스템** (MEMO.md 1순위) ✅ 완료 (2025-10-05)
   - 200+ 테스트 케이스 작성
   - 91% 통과율 달성
   - pytest 기반 자동화 시스템

2. **Error Handling 시스템** (MEMO.md 2순위) ✅ 완료 (2025-10-07)
   - 40+ 커스텀 예외 클래스
   - 전역 에러 핸들러 4개
   - 에러 추적 및 통계 API
   - 25개 테스트 100% 통과

### 다음 진행 작업
3. **Chat Interaction API 고도화** (MEMO.md 3순위)
   - 사용자 상호작용 경험 향상
   - 대화 컨텍스트 관리 개선
   - 개인화 기능 추가

### 중장기 계획
4. **Analytics API**: 사용자 분석 및 패턴 학습
5. **Expression API**: LED 표정, 버저 소리 제어
6. **지능형 매핑**: SLAM 알고리즘 적용
7. **자율 탐사**: 책상 환경 자동 탐색
8. **스마트 홈 연동**: IoT 기기 제어

### 🎉 현재 달성 상황
- ✅ **1순위 완료**: Testing (코드 품질 보장) - 200+ 테스트, 91% 통과율
- ✅ **2순위 완료**: Error Handling (안정성 확보) - 체계적 에러 처리 시스템
- 🎯 **3순위 준비**: Chat Interaction API (대화 시스템 고도화)
- 📋 **개발 로드맵**: MEMO.md 우선순위에 따른 체계적 진행

---

**Deks 1.0** - 책상 위의 작은 친구가 되어주는 스마트 로봇
