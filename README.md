# Deks 1.0 - 책상 위 이동 로봇

Deks는 책상 위에서 안전하게 돌아다니며 대화할 수 있는 스마트 로봇입니다.

## 🤖 로봇 구성

### 하드웨어
- **두뇌**: ESP32 S3 (Wi-Fi 연결 및 TCP 클라이언트)
- **다리**: FIT0405 DC 모터 + 엔코더 (정밀한 위치 제어)
- **모터 드라이버**: L298N (모터 제어)
- **얼굴**: 1588AS (8x8 LED Dot Matrix 표정 표현)
- **성대**: 패시브 버저 (음성 피드백)
- **귀** (향후 계획): I2S MEMS 마이크 (INMP441, TinyML 음성 인식용)
- **낙하 방지**: 적외선 센서 1개 (앞쪽만 설치)
- **장애물 감지**: 적외선 센서 1개 (전방)

## 🎯 주요 기능

### 1. 웹 기반 대화 인터페이스
- 웹 브라우저를 통해 로봇과 실시간 대화
- **자연어 명령으로 로봇 제어** ✅ 완성
- 로봇의 응답과 상태 모니터링
- 채팅창에서 "앞으로 가줘", "왼쪽으로 돌아" 등 자연어 입력 가능

### 2. 스마트 이동 제어 ✅ 완성
- 자연어 명령으로 이동 방향 제어
- **ESP32 S3 MicroPython 펌웨어** 구동
- **실시간 양방향 통신** (TCP Socket + WebSocket)
- 제자리 회전으로 방향 전환
- **자동 재연결** (서버 재시작 시 1~2초 내 재연결)

### 3. 안전 시스템 ✅ 구현
- 낙하 방지: 적외선 센서 감지
- 장애물 회피: 전방 센서
- 배터리 모니터링
- 비상 정지 기능

### 4. 하드웨어 통합 🔧 진행 중 (2025-10-08)
- ✅ ESP32 S3 펌웨어 개발 완료
- ✅ 펌웨어 모듈 구현 (모터, 센서, LED 매트릭스, 버저)
- ✅ Wi-Fi 연결 및 자동 재연결
- ✅ Socket Bridge 통신 성공
- ✅ 자연어 명령 → ESP32 전달 완성
- ⏳ 실제 하드웨어 연결 테스트 대기 중
  - 모터 드라이버 (L298N)
  - LED 매트릭스 (1588AS)
  - 센서 (적외선, 엔코더)
  - 버저

### 5. 환경 매핑 (향후 계획)
- 모터 엔코더, 적외선 센서 데이터 융합
- 실시간 책상 지도 작성
- 경로 계획 및 최적화
- **상태**: 미개발 (7순위 이후)

## 🛡️ 안전 기능

### 낙하 방지 시스템
- 적외선 센서로 책상 가장자리 감지
- 감지 시 즉시 정지 및 180도 회전 후 전진
- **Deks의 핵심 철학**: "책상 위에서 떨어지면 안됨"
- **Deks1.0 특징**:
  - 이동: 전진과 회전만 지원 (후진 불가)
  - 음성: 버저로 감정 표현
  - 대화: 브라우저 채팅 창에서 텍스트 대화 가능

### 장애물 회피
- 적외선 센서로 전방 장애물 감지
- 자동 정지 및 회피 동작
- 안전한 거리 유지

## 🎮 제어 예시

```
사용자: "앞으로 가"
Deks: "앞으로 이동합니다!" (전진 시작)

사용자: "오른쪽으로 돌아"
Deks: "오른쪽으로 회전합니다!" (제자리 회전)

낙하 감지 시: "위험 감지! 정지합니다!" (즉시 정지)
```

## 🔧 기술 스택

- **하드웨어**: ESP32 S3, 마이크로파이썬
- **설계툴**: Onshape
- **보드 설계**: KiCAD
- **통신**: Wi-Fi
- **센서 융합**: 엔코더 + 적외선
- **웹 인터페이스**: HTML/CSS/JavaScript
- **웹 서버**: 파이썬 FastAPI (Socket Bridge 통합)
- **자연어 처리**: 규칙 기반 명령 파싱
- **데이터베이스**: SQLite
- **제어 알고리즘**: PID 제어, 센서 융합

## 📋 개발 상태

### ✅ 완료된 작업
- [x] 기획
- [x] 기본 하드웨어 구성
- [x] 웹 인터페이스 개발
- [x] 기본 이동 제어
- [x] 안전 시스템 구현
- [x] 백엔드 API 개발
- [x] 자연어 처리 시스템
- [x] 데이터베이스 설계
- [x] 테스트 시스템 구축 (1순위 완료)
- [x] 에러 처리 시스템 구축 (2순위 완료)
- [x] 대화 시스템 고도화 (3순위 완료)
- [x] 사용자 분석 시스템 (4순위 완료)
- [x] 표현 제어 API (5순위 완료)
- [x] **ESP32 하드웨어 연동 (6순위 완료)** ✅ **2025-10-08**
  - ✅ 펌웨어 개발 및 통신 프로토콜 완성
  - ⏳ 실제 하드웨어 조립 및 통합 테스트 대기

### 🔮 향후 계획 (우선순위 7순위 이후)
- [ ] **TinyML 도입** (7순위 계획)
  - 온디바이스 ML 모델 추론
  - 음성 명령 인식
  - 낙하 위험 예측
- [ ] **환경 매핑** (SLAM)
  - 센서 융합 기반 매핑
  - 실시간 지도 작성
- [ ] **경로 계획 알고리즘**
  - 최적 경로 계산
  - 장애물 회피 경로
- [ ] **자율 탐사**
  - 자동 환경 탐색
  - 미지의 영역 탐사
- [ ] **스마트 홈 연동**
  - IoT 기기 제어
  - 홈 오토메이션

## 🧪 테스트 현황

### ✅ 통과한 테스트 (총 305개)

#### 핵심 기능 테스트 (100% 통과)
- **NLP 자연어 처리**: 48개 테스트 ✅
  - 의도 분석, 감정 분석, 키워드 추출, 엔티티 인식
  - 질문 유형 분류, 유사도 계산, 한국어 처리
  - 한글 인코딩 문제 해결, NLP 로직 정확도 개선
  
- **API 통합 테스트**: 24개 테스트 ✅
  - FastAPI 엔드포인트, CORS 설정, 요청 검증
  - 채팅 API, 감정 업데이트, 학습 데이터 관리
  - CORS 헤더 테스트 수정 완료
  
- **데이터베이스 관리**: 27개 테스트 ✅
  - SQLite 연결, 사용자 상호작용 저장
  - 명령 빈도 추적, 에러 패턴 저장, 로봇 상태 관리
  - SQLite 연결 상태 확인 로직 개선
  
- **로봇 제어기**: 35개 테스트 ✅
  - 이동 명령 처리, 명령 큐 관리, 상태 관리
  - 비상 정지, 명령 히스토리, 속도 검증
  - 명령 처리 루프 무한 대기 문제 해결
  
- **센서 관리자**: 25개 테스트 ✅
  - 센서 데이터 처리, 알림 시스템, 히스토리 관리
  - 배터리 모니터링, 낙하 감지, 실시간 스트리밍
  - 스트리밍 클라이언트 테스트 수정 완료
  
- **Socket Bridge**: 24개 테스트 ✅
  - TCP 서버, 클라이언트 연결, 핸드셰이크
  - 메시지 처리, 하트비트, 명령 전송
  
- **WebSocket 통합**: 17개 테스트 ✅
  - 실시간 통신, 메시지 에코, 연결 관리
  - 무효 JSON 처리 테스트 수정 완료

- **Error Handling (에러 처리)**: 25개 테스트 ✅ (100% 통과)
  - 커스텀 예외 클래스 테스트 (11개)
  - 예외 래핑 및 변환 (3개)
  - HTTP 상태 코드 매핑 (3개)
  - 에러 응답 모델 (2개)
  - 에러 코드 시스템 (2개)
  - 에러 핸들러 통합 (2개)
  - 에러 상세 정보 (2개)

- **Chat Interaction Enhanced (강화된 대화 시스템)**: 39개 테스트 ✅ (100% 통과)
  - 대화 컨텍스트 관리 테스트 (7개)
  - 감정 분석 시스템 테스트 (10개)
  - 강화된 시나리오 테스트 (7개)
  - 사용자 기억 시스템 테스트 (4개)
  - 감정 응답 시스템 테스트 (3개)
  - 채팅 서비스 통합 테스트 (3개)
  - 대화 흐름 테스트 (2개)
  - 컨텍스트 기반 응답 테스트 (3개)

- **Analytics (사용자 분석 및 패턴 학습)**: 21개 테스트 ✅ (100% 통과)
  - Analytics 서비스 테스트 (7개)
  - 에러 수정 제안 테스트 (3개)
  - 전체 통계 테스트 (2개)
  - 사용자 통계 테스트 (2개)
  - 스마트 제안 테스트 (3개)
  - 파라미터 검증 테스트 (2개)
  - API 통합 테스트 (2개)

#### 시나리오 테스트 (45% 통과)
- **채팅 상호작용**: 4개 중 4개 통과 ✅
  - 첫 만남 시나리오, 도움 요청, 감정 트렌드, 질문 유형 감지
- **에러 핸들링**: 4개 중 3개 통과 ✅
  - Socket Bridge 연결 에러, 로봇 제어기 에러, 센서 데이터 처리 에러
- **시스템 통합**: 4개 중 2개 통과 ✅
  - 완전한 사용자 상호작용, 에러 복구, 동시 작업 처리

### 🔧 수정 완료된 주요 이슈

1. **한글 인코딩 문제** 해결 ✅
   - PowerShell 환경에서 한글 문자 깨짐 문제 수정
   - NLP 테스트에서 유니코드 처리 개선
   - 엔티티 추출 로직 정확도 향상

2. **비동기 처리 최적화** ✅
   - WebSocket 무한 대기 문제 해결
   - 로봇 제어기 명령 처리 루프 안정화
   - async fixture 호환성 문제 해결

3. **데이터베이스 호환성** ✅
   - SQLite 연결 상태 확인 로직 개선
   - 임시 데이터베이스 fixture 추가
   - 연결 컨텍스트 매니저 테스트 수정

4. **API 및 통신 안정성** ✅
   - FastAPI CORS 헤더 테스트 수정
   - 센서 스트리밍 클라이언트 테스트 수정
   - WebSocket 에러 처리 개선

5. **NLP 분석 정확도** ✅
   - 감정 분석 로직 개선 (PROUD, HELPFUL 등)
   - 질문 타입 추출 정확도 향상
   - 키워드 추출 알고리즘 최적화

### 📊 테스트 커버리지

| 모듈 | 테스트 수 | 통과율 | 상태 |
|------|-----------|--------|------|
| NLP 처리 | 48 | 100% | ✅ 완료 |
| API 통합 | 24 | 100% | ✅ 완료 |
| 데이터베이스 | 27 | 100% | ✅ 완료 |
| 로봇 제어 | 35 | 100% | ✅ 완료 |
| 센서 관리 | 25 | 100% | ✅ 완료 |
| Socket Bridge | 24 | 100% | ✅ 완료 |
| WebSocket | 17 | 100% | ✅ 완료 |
| **Error Handling** | **25** | **100%** | ✅ **완료** |
| **Chat Enhanced** | **39** | **100%** | ✅ **완료** |
| **Analytics** | **21** | **100%** | ✅ **완료** |
| 시나리오 | 20 | 45% | 🔧 진행중 |
| **전체** | **305** | **96%** | ✅ **우수** |

### 🎯 테스트 품질 지표

- **핵심 기능**: 100% 통과 (285개 테스트)
- **에러 처리**: 100% 통과 (25개 테스트)
- **대화 시스템**: 100% 통과 (39개 테스트)
- **Analytics**: 100% 통과 (21개 테스트)
- **시나리오 테스트**: 45% 통과 (20개 중 9개)
- **코드 품질**: 우수 (MEMO.md 1-4순위 목표 달성)
- **안정성**: 매우 높음 (체계적 에러 처리 + 테스트)
- **대화 품질**: 높음 (컨텍스트 기반 맞춤 응답)
- **사용자 경험**: 데이터 기반 최적화 (스마트 제안)
- **한국어 처리**: 완벽 (인코딩 문제 해결)

### 🎯 테스트 실행 방법

```bash
# 전체 테스트 실행
python -m pytest backend/tests/ -v

# 특정 모듈 테스트
python -m pytest backend/tests/test_chat_nlp.py -v
python -m pytest backend/tests/test_api_integration.py -v
python -m pytest backend/tests/test_error_handling.py -v

# 에러 처리 시스템 테스트
python -m pytest backend/tests/test_error_handling.py -v
python -m pytest backend/tests/test_error_api_integration.py -v

# 강화된 대화 시스템 테스트
python -m pytest backend/tests/test_chat_interaction_enhanced.py -v

# Analytics 시스템 테스트
python -m pytest backend/tests/test_analytics.py -v

# 커버리지 포함 테스트
python -m pytest backend/tests/ --cov=app --cov-report=html
```

### 🔍 테스트 환경

- **Python**: 3.13.3
- **테스트 프레임워크**: pytest 8.4.2
- **비동기 테스트**: pytest-asyncio 1.2.0
- **HTTP 테스트**: httpx 0.25.2
- **모킹**: unittest.mock

## 🚀 향후 계획

### ✅ 완료된 작업
1. **Testing 시스템** (MEMO.md 1순위) ✅ 완료 (2025-10-05)
   - 200+ 테스트 케이스 작성
   - 91% 통과율 달성
   - pytest 기반 자동화 시스템

2. **Error Handling 시스템** (MEMO.md 2순위) ✅ 완료 (2025-10-07)
   - 40+ 커스텀 예외 클래스
   - 전역 에러 핸들러 4개
   - 에러 추적 및 통계 API
   - 25개 테스트 100% 통과

3. **Chat Interaction API 고도화** (MEMO.md 3순위) ✅ 완료 (2025-10-07)
   - 강화된 대화 컨텍스트 관리 (장기 기억)
   - 고도화된 감정 분석 시스템 (16개 감정 상태)
   - 확장된 대화 시나리오 (20개)
   - 개인화 시스템 (선호도/관심사 학습)
   - 39개 테스트 100% 통과

4. **Analytics API** (MEMO.md 4순위) ✅ 완료 (2025-10-07)
   - 사용자 행동 추적 (빈도, 시간대, 패턴)
   - 스마트 제안 시스템 (4가지 알고리즘)
   - 사용자 프로필 분석 (학습 레벨, 통계)
   - 에러 패턴 분석 및 자동 제안
   - 21개 테스트 100% 통과

5. **Expression API** (MEMO.md 5순위) ✅ 완료 (2025-10-07)
   - LED 표정 제어 API
   - 버저 소리 제어 API
   - 상황별 자동 표현 시스템

6. **ESP32 하드웨어 연동** (MEMO.md 6순위) 🔧 진행 중 (2025-10-08)
   - ✅ ESP32 S3 MicroPython 펌웨어 개발
   - ✅ 하드웨어 제어 모듈 구현 (모터, 센서, LED, 버저)
   - ✅ Wi-Fi 자동 연결 및 즉시 재연결 (1~2초)
   - ✅ Socket Bridge 통합 및 통신 성공
   - ✅ 자연어 명령 → ESP32 전달 완성
   - ✅ End-to-End 소프트웨어 통합 성공
   - ⏳ 실제 하드웨어 연결 및 테스트 대기
     - L298N 모터 드라이버
     - 1588AS LED 매트릭스 (GPIO 35~42)
     - 적외선 센서 (낙하, 장애물)
     - 엔코더 (왼쪽/오른쪽)
     - 패시브 버저

### 중장기 계획

7. **TinyML 도입 계획** 🧠 (2025 Q4 ~ 2026 Q2)
   
   #### 목표
   ESP32 S3에서 머신러닝 모델을 직접 실행하여 실시간 온디바이스 AI 기능 구현
   
   #### 1단계: 기반 구축 (2025 Q4)
   - **개발 환경 설정**
     - TensorFlow Lite for Microcontrollers 설치
     - ESP-IDF 및 MicroPython TensorFlow 라이브러리 통합
     - 모델 변환 파이프라인 구축 (.tflite 포맷)
   
   - **센서 데이터 수집 시스템**
     - 적외선 센서 데이터 로깅 (낙하/장애물 패턴)
     - 엔코더 데이터 수집 (이동 패턴)
     - 배터리 및 환경 데이터 수집
     - 데이터셋 구축 (최소 1000개 샘플)
   
   - **첫 번째 모델: 낙하 위험 예측**
     - 입력: 적외선 센서 값, 엔코더 속도, 이동 방향
     - 출력: 위험도 점수 (0.0 ~ 1.0)
     - 모델 크기: <50KB (ESP32 S3 메모리 제약)
     - 추론 시간: <10ms (실시간 대응)
   
   #### 2단계: 기본 AI 기능 (2026 Q1)
   - **제스처/패턴 인식**
     - 센서 데이터 기반 사용자 제스처 인식
     - 책상 표면 패턴 학습 (거친 면, 미끄러운 면)
     - CNN 기반 경량 모델 (Quantization 적용)
   
   - **온디바이스 음성 명령 인식**
     - 키워드 스포팅 (Wake Word Detection)
     - 기본 명령어 5개 인식 ("앞", "뒤", "왼쪽", "오른쪽", "정지")
     - 마이크 추가 필요 (I2S MEMS 마이크)
   
   - **강화학습 기반 이동 최적화**
     - Q-Learning 경량 구현
     - 에너지 효율적 경로 학습
     - 장애물 회피 전략 자동 개선
   
   #### 3단계: 고급 AI 기능 (2026 Q2)
   - **감정 인식 시스템**
     - 사용자 상호작용 패턴 분석
     - 음성 톤 분석 (마이크 필요)
     - LED 표정 자동 생성
   
   - **이상 패턴 감지**
     - 센서 고장 자동 감지
     - 비정상 이동 패턴 경고
     - 배터리 이상 조기 예측
   
   - **연합학습 (Federated Learning)**
     - 여러 Deks 로봇 간 학습 공유
     - 개인정보 보호하며 집단 지능 구현
     - 클라우드 동기화 (선택적)
   
   #### 기술 스택
   - **ML 프레임워크**: TensorFlow Lite for Microcontrollers
   - **모델 최적화**: Quantization (8-bit), Pruning
   - **개발**: Python (모델 학습) + C/MicroPython (배포)
   - **데이터**: SQLite (학습 데이터), CSV (전처리)
   - **추가 하드웨어**: 
     - I2S MEMS 마이크 (음성 인식용)
     - 추가 메모리 (필요시 PSRAM 활용)
   
   #### 예상 성과
   - **지연시간 감소**: 서버 통신 없이 즉각 반응 (10ms 이내)
   - **네트워크 독립성**: Wi-Fi 없이도 기본 AI 기능 작동
   - **개인화**: 사용자별 맞춤 학습 및 행동 패턴
   - **에너지 효율**: 클라우드 통신 최소화로 배터리 수명 30% 향상
   - **안전성 향상**: 낙하 사고 99% 예방
   
   #### 제약사항 및 해결방안
   - **메모리 제한** (ESP32 S3: 512KB SRAM)
     → 8-bit Quantization, 모델 크기 <100KB
   - **연산 능력** (240MHz Dual-core)
     → 경량 모델 (MobileNet, SqueezeNet 기반)
   - **학습 데이터 부족**
     → 시뮬레이션 + Transfer Learning
   - **전력 소비**
     → 추론 주기 최적화 (100Hz → 10Hz)
   
   #### 성공 지표
   - [ ] 첫 TinyML 모델 배포 (낙하 예측 정확도 >95%)
   - [ ] 온디바이스 추론 시간 <10ms
   - [ ] 모델 크기 <100KB
   - [ ] 배터리 수명 영향 <5%
   - [ ] 음성 명령 인식 정확도 >90%

8. **Deks 추가 기능** (향후 계획 - 우선순위 8~10)
   
   **8-1. 환경 매핑 및 SLAM** (우선순위 8)
   - 센서 융합 기반 SLAM 알고리즘
   - 실시간 책상 지도 작성
   - 위치 추정 및 추적
   - 데이터: 엔코더 + 적외선 센서 융합
   - **상태**: 미개발
   
   **8-2. 경로 계획 및 자율 탐사** (우선순위 9)
   - A* 또는 RRT 기반 경로 계획
   - 동적 장애물 회피
   - 자율적 환경 탐색
   - 미지의 영역 탐사
   - **상태**: 미개발
   
   **8-3. 스마트 홈 연동** (우선순위 10)
   - IoT 기기 제어 (조명, 온도 등)
   - 홈 오토메이션 시나리오
   - MQTT 프로토콜 통합
   - **상태**: 미개발

### 🎉 현재 달성 상황 (2025-10-08 기준)
- ✅ **1순위 완료**: Testing (코드 품질 보장) - 305개 테스트, 96% 통과율
- ✅ **2순위 완료**: Error Handling (안정성 확보) - 체계적 에러 처리 시스템
- ✅ **3순위 완료**: Chat Interaction API (대화 시스템 고도화) - 장기 기억 + 감정 분석
- ✅ **4순위 완료**: Analytics API (사용자 분석) - 스마트 제안 + 패턴 학습
- ✅ **5순위 완료**: Expression API (로봇 표현력 향상) - LED + 버저 제어
- ✅ **6순위 완료**: ESP32 하드웨어 연동
  - ✅ 펌웨어 개발 및 소프트웨어 통합 완료
  - ✅ 통신 프로토콜 및 Socket Bridge 완성
  - ⏳ 실제 하드웨어 조립 및 통합 테스트 대기
- 📋 **7순위 계획**: TinyML 도입 (2025 Q4 ~ 2026 Q2)
- 📋 **개발 로드맵**: MEMO.md 우선순위 1~6순위 완료

---

**Deks 1.0** - 책상 위의 작은 친구가 되어주는 스마트 로봇
